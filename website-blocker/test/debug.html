<!DOCTYPE html>
<html>
<head>
    <title>Rule Debug</title>
    <style>
        .success { color: green; }
        .error { color: red; }
        button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h2>Website Blocker Debug Panel</h2>
    <button onclick="testGetAllRules()">Get All Rules</button>
    <button onclick="testAddRule('example.com')">Add example.com</button>
    <button onclick="testAddRule('test.com')">Add test.com</button>
    <button onclick="testRemoveAllRules()">Remove All Dynamic Rules</button>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            output.insertBefore(div, output.firstChild);
            console.log(message);
        }

        async function testGetAllRules() {
            try {
                const dynamicRules = await chrome.declarativeNetRequest.getDynamicRules();
                const staticRules = await chrome.declarativeNetRequest.getSessionRules();
                log('Dynamic Rules: ' + JSON.stringify(dynamicRules, null, 2));
                log('Static Rules: ' + JSON.stringify(staticRules, null, 2));
            } catch (error) {
                log('Error getting rules: ' + error.message, true);
                console.error('Error:', error);
            }
        }

        async function testAddRule(domain) {
            try {
                // Get current rules to check IDs
                const currentRules = await chrome.declarativeNetRequest.getDynamicRules();
                const staticRules = await chrome.declarativeNetRequest.getSessionRules();
                const allRuleIds = [...currentRules, ...staticRules].map(r => r.id);
                const newId = allRuleIds.length ? Math.max(...allRuleIds) + 1 : 100;

                const newRule = {
                    id: newId,
                    priority: 1,
                    action: { type: 'block' },
                    condition: {
                        urlFilter: `||${domain}^`,
                        resourceTypes: ['main_frame']
                    }
                };

                await chrome.declarativeNetRequest.updateDynamicRules({
                    addRules: [newRule],
                    removeRuleIds: []
                });

                log(`Successfully added rule for ${domain} with ID ${newId}`);
                testGetAllRules();
            } catch (error) {
                log(`Error adding rule for ${domain}: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        async function testRemoveAllRules() {
            try {
                const rules = await chrome.declarativeNetRequest.getDynamicRules();
                await chrome.declarativeNetRequest.updateDynamicRules({
                    removeRuleIds: rules.map(r => r.id)
                });
                log('Successfully removed all dynamic rules');
                testGetAllRules();
            } catch (error) {
                log('Error removing rules: ' + error.message, true);
                console.error('Error:', error);
            }
        }

        // Initial rules check
        testGetAllRules();
    </script>
</body>
</html>
